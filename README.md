以下是传感器采集与上报系统的 **七步整体流程** 汇总：

1. **通信协议接入**
   支持 Modbus TCP/RTU-over-TCP、Siemens S7、Mitsubishi SLMP、SNMP、HTTP(S)、TCP 客户端、MQTT、OPC UA 等多种工业协议，通过统一的 `Protocol` 接口动态加载、注册并管理。

2. **定义协议接入参数**
   为每种协议配置必要参数（如 IP、端口、单元 ID、Rack/Slot、社区字串、URL、校验、超时、重试等），并在系统启动或运行时通过 YAML/JSON 将这些参数注入到各协议驱动。

3. **添加设备**
   从配置文件或 API 批量导入设备元数据（ID、名称、描述、协议、采集间隔、是否心跳检测），为每台设备创建协议客户端实例，并启动健康监测与断线重连协程。

4. **点位 → 物模型映射**
   定义设备原始点位（寄存器、线圈、输入点、HTTP 字段等）到标准物模型字段的映射，指定数据类型、单位、转换表达式及本地报警规则（阈值、表达式、等级、消息）。

5. **边缘计算**
   在本地对采集到的原始数据或映射后值执行数据聚合（平均、最大、滑动窗口）、异常过滤、规则引擎（报警触发）和联动控制（如 `fan_speed<500 → 关闭泵`），实现实时、高效的本地决策。

6. **上行协议接入**
   将处理后数据、报警及计算结果推送至云端或第三方系统，支持 MQTT、HTTP Push、Kafka、NATS、Redis Pub、Sparkplug B 等多种协议；配置化管理多通道并行发送、重试策略与安全认证。

7. **上行报文格式自定义**
   允许用户通过模板（JSON/Raw/Form）、字段映射（重命名）、过滤条件（只上传报警项）、以及自定义脚本（Go `text/template`）来生成最终报文，同时兼容 Sparkplug B Payload、CBOR、Base64 等格式，并集成持久化队列、证书管理与重连策略，确保生产级可靠性与安全性。
请优化代码!